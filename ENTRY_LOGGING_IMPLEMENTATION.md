# Entry Logging Implementation

## Overview
This document describes the implementation of the entry logging system for the Gardenia 2025 QR Scanner. When a ticket is scanned and verified, the scanner can now save participant data to MongoDB based on whether entry is allowed or declined.

## Features Implemented

### 1. Database Schemas

Two new MongoDB schemas have been created to store entry decisions:

#### AllowedEntry Schema (`backend/models/AllowedEntry.js`)
- Stores all participant data when entry is allowed
- Includes registration details, event information, participant details, and team members
- Automatically timestamps when entry was scanned and logged

#### DeclineEntry Schema (`backend/models/DeclineEntry.js`)
- Stores all participant data when entry is declined
- Includes an optional `reason` field for tracking why entry was denied
- Automatically timestamps when entry was scanned and logged

Both schemas include:
- Complete participant information (leader and team members)
- Event details
- Registration ID and status
- Timestamps for tracking
- Indexed fields for fast queries

### 2. API Endpoints

#### POST `/api/register/entry-log`
**Purpose:** Log entry decisions (allow or decline)

**Request Body:**
```json
{
  "registrationId": "REG12345",
  "eventId": "event_object_id",
  "action": "ENTRY_ALLOWED" | "ENTRY_DENIED",
  "timestamp": "2025-10-14T10:30:00.000Z",
  "reason": "Optional reason for decline"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Entry allowed and logged successfully",
  "data": {
    "id": "entry_document_id",
    "registrationId": "REG12345",
    "action": "ENTRY_ALLOWED",
    "timestamp": "2025-10-14T10:30:00.000Z"
  }
}
```

**Behavior:**
- Validates the registration exists
- Fetches complete participant data from the Registration collection
- Saves to `AllowedEntry` collection if action is `ENTRY_ALLOWED`
- Saves to `DeclineEntry` collection if action is `ENTRY_DENIED`
- Returns success confirmation with entry ID

#### GET `/api/register/entries/allowed`
**Purpose:** Retrieve all allowed entries with pagination

**Query Parameters:**
- `page` (optional): Page number (default: 1)
- `limit` (optional): Entries per page (default: 50)

**Response:**
```json
{
  "success": true,
  "data": {
    "entries": [...],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 150,
      "pages": 3
    }
  }
}
```

#### GET `/api/register/entries/declined`
**Purpose:** Retrieve all declined entries with pagination

**Query Parameters:**
- `page` (optional): Page number (default: 1)
- `limit` (optional): Entries per page (default: 50)

**Response:** Same format as allowed entries

#### GET `/api/register/entries/stats`
**Purpose:** Get statistics about entries

**Response:**
```json
{
  "success": true,
  "data": {
    "total": {
      "allowed": 150,
      "declined": 25,
      "total": 175
    },
    "byEvent": {
      "allowed": [
        {
          "_id": "event_id",
          "eventTitle": "Event Name",
          "count": 50
        }
      ],
      "declined": [...]
    }
  }
}
```

### 3. Frontend Integration

The QR Scanner page (`frontend/src/pages/QRScanner.jsx`) is already configured to use these endpoints:

**Allow Entry Button (Line 177-217):**
- Calls POST `/api/register/entry-log` with action `ENTRY_ALLOWED`
- Shows loading state for minimum 4 seconds
- Displays success message
- Auto-resets after 3 seconds

**Decline Entry Button (Line 219-259):**
- Calls POST `/api/register/entry-log` with action `ENTRY_DENIED`
- Shows loading state for minimum 4 seconds
- Displays denial message
- Auto-resets after 3 seconds

## Data Stored

For each entry (allowed or declined), the following data is saved:

### Registration Information
- Registration ID (regId)
- Registration status (APPROVED/PENDING/REJECTED)
- Student type (GCU student or external)
- Final event date

### Event Details
- Event title, category, department
- Event type and time
- Event location

### Participant Information
- Leader name, email, phone
- Registration/Roll number
- College/School name (for external students)
- All team members (if applicable)

### Timestamps
- `scannedAt`: When the QR code was scanned
- `loggedAt`: When the entry was saved to database
- `createdAt`: Auto-generated by MongoDB
- `updatedAt`: Auto-generated by MongoDB

### Additional Fields (DeclineEntry only)
- `reason`: Optional reason for declining entry

## Database Indexes

Both schemas include indexes on:
- `regId`: For quick lookup by registration ID
- `registrationId`: For reference queries
- `eventId`: For event-based filtering
- `scannedAt`: For chronological sorting

## Error Handling

The implementation includes comprehensive error handling:
- Validates required fields
- Checks if registration exists before logging
- Returns appropriate error messages
- Logs errors to console for debugging
- Provides user-friendly error messages

## Usage Example

### Scanning Flow:
1. User scans QR code on scanner page
2. System validates registration and displays participant info
3. User clicks "Allow Entry" or "Decline Entry"
4. System:
   - Fetches complete registration data
   - Creates entry log with all participant information
   - Saves to appropriate MongoDB collection
   - Returns confirmation
5. Scanner resets for next scan

### Viewing Entries:
```javascript
// Get all allowed entries (page 1)
GET /api/register/entries/allowed?page=1&limit=50

// Get all declined entries (page 2)
GET /api/register/entries/declined?page=2&limit=50

// Get entry statistics
GET /api/register/entries/stats
```

## Security Considerations

- All endpoints validate input data
- Registration existence is verified before logging
- Error messages don't expose sensitive information
- Timestamps are server-generated to prevent tampering

## Excel Export Functionality

### Admin Export Endpoints

Two Excel export endpoints are available for administrators:

#### Export Allowed Entries
**Endpoint:** `GET /api/admin/entries/allowed/export`  
**Authentication:** Required (Admin JWT Token)  
**Query Parameters:**
- `eventId` (optional): Filter by specific event
- `search` (optional): Search by name, email, phone, or registration ID

**Excel File Includes:**
- Serial number
- Registration ID
- Complete event details (title, category, department, type, date, time, location)
- Student type (GCU/External)
- Team size
- Leader information (name, email, phone, register number or college details)
- All team members with complete details
- Entry scanned timestamp
- Entry logged timestamp
- Status

**Example:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:5000/api/admin/entries/allowed/export" \
  --output allowed_entries.xlsx
```

#### Export Declined Entries
**Endpoint:** `GET /api/admin/entries/declined/export`  
**Authentication:** Required (Admin JWT Token)  
**Query Parameters:**
- `eventId` (optional): Filter by specific event
- `search` (optional): Search by name, email, phone, or registration ID

**Excel File Includes:**
- All fields from Allowed Entries
- **Decline Reason:** Why entry was denied

**Example:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:5000/api/admin/entries/declined/export" \
  --output declined_entries.xlsx
```

### Admin Dashboard Statistics

The admin dashboard (`/api/admin/stats`) now includes:

**Entry Statistics:**
- `totalAllowedEntries`: Total number of allowed entries
- `totalDeclinedEntries`: Total number of declined entries
- `totalEntries`: Combined total of all entry scans
- `allowedEntriesPerEvent`: Breakdown of allowed entries by event
- `declinedEntriesPerEvent`: Breakdown of declined entries by event

These statistics are displayed in the admin dashboard with dedicated cards showing:
1. **Allowed Entries** - with green checkmark icon
2. **Declined Entries** - with red X icon
3. **Total Entry Scans** - combined count with QR code icon

## Future Enhancements

Possible improvements:
1. Add authentication/authorization for public entry endpoints
2. ✅ **COMPLETED:** Add export functionality for entry logs
3. ✅ **COMPLETED:** Add real-time dashboard for entry monitoring
4. Add duplicate entry detection and warnings
5. Add entry reversal/correction functionality
6. Add advanced search and filter capabilities for entry logs
7. Add email notifications for declined entries
8. Add entry history timeline for each registration
9. Add entry analytics and reporting charts

## Testing

To test the implementation:

1. **Start the backend server:**
   ```bash
   cd backend
   npm start
   ```

2. **Open the QR Scanner:**
   Navigate to `/qr-scanner` in the frontend

3. **Scan a valid QR code:**
   - The system will validate the registration
   - Click "Allow Entry" or "Decline Entry"
   - Check MongoDB to verify the entry was saved

4. **View entries:**
   ```bash
   # View allowed entries
   curl http://localhost:5000/api/register/entries/allowed

   # View declined entries
   curl http://localhost:5000/api/register/entries/declined

   # View statistics
   curl http://localhost:5000/api/register/entries/stats
   ```

## Files Modified/Created

### Created:
- `backend/models/AllowedEntry.js` - Schema for allowed entries
- `backend/models/DeclineEntry.js` - Schema for declined entries
- `ENTRY_LOGGING_IMPLEMENTATION.md` - This documentation

### Modified:
- `backend/routes/registrations.js`:
  - Added imports for new schemas
  - Updated `/entry-log` endpoint to save to database
  - Added `/entries/allowed` endpoint
  - Added `/entries/declined` endpoint
  - Added `/entries/stats` endpoint

### Existing (No changes required):
- `frontend/src/pages/QRScanner.jsx` - Already configured to call the API

## Troubleshooting

### Entry not saving to database
- Check MongoDB connection
- Verify registration ID exists in database
- Check server logs for errors

### Can't retrieve entries
- Ensure MongoDB collections were created
- Check pagination parameters
- Verify data exists in collections

### Performance issues
- Check database indexes are created
- Consider adding caching for statistics
- Optimize pagination limits

## Support

For questions or issues, check:
1. Server logs: `backend/logs/`
2. MongoDB collections: `allowedentries` and `declineentries`
3. Browser console for frontend errors

